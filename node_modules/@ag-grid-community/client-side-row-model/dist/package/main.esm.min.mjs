import{_defineModule as v}from"@ag-grid-community/core";import{ModuleNames as T,RowModelHelperService as _,_CsrmSsrmSharedApiModule as U}from"@ag-grid-community/core";import{BeanStub as B,ChangedPath as V,ClientSideRowModelSteps as h,RowHighlightPosition as M,RowNode as F,_debounce as W,_errorOnce as P,_exists as N,_insertIntoArray as Y,_last as j,_missing as S,_missingOrEmpty as $,_removeFromArray as K}from"@ag-grid-community/core";import{RowNode as Q,_cloneObject as q,_errorOnce as D,_missingOrEmpty as y,_sortRowNodesByOrder as X,_warnOnce as b}from"@ag-grid-community/core";var z="ROOT_NODE_ID",G=0,J=class{constructor(e,t,o,s,r,i){this.nextId=0,this.rowCountReady=!1,this.allNodesMap={},this.rootNode=e,this.gos=t,this.eventService=o,this.funcColsService=s,this.beans=i,this.selectionService=r,this.rootNode.group=!0,this.rootNode.level=-1,this.rootNode.id=z,this.rootNode.allLeafChildren=[],this.rootNode.childrenAfterGroup=[],this.rootNode.childrenAfterSort=[],this.rootNode.childrenAfterAggFilter=[],this.rootNode.childrenAfterFilter=[]}getCopyOfNodesMap(){return q(this.allNodesMap)}getRowNode(e){return this.allNodesMap[e]}setRowData(e){if(typeof e=="string"){b("rowData must be an array.");return}this.rowCountReady=!0,this.dispatchRowDataUpdateStartedEvent(e);const t=this.rootNode,o=this.rootNode.sibling;t.childrenAfterFilter=null,t.childrenAfterGroup=null,t.childrenAfterAggFilter=null,t.childrenAfterSort=null,t.childrenMapped=null,t.updateHasChildren(),this.nextId=0,this.allNodesMap={},e?t.allLeafChildren=e.map(s=>this.createNode(s,this.rootNode,G)):(t.allLeafChildren=[],t.childrenAfterGroup=[]),o&&(o.childrenAfterFilter=t.childrenAfterFilter,o.childrenAfterGroup=t.childrenAfterGroup,o.childrenAfterAggFilter=t.childrenAfterAggFilter,o.childrenAfterSort=t.childrenAfterSort,o.childrenMapped=t.childrenMapped,o.allLeafChildren=t.allLeafChildren)}updateRowData(e,t){this.rowCountReady=!0,this.dispatchRowDataUpdateStartedEvent(e.add);const o={remove:[],update:[],add:[]},s=[];return this.executeRemove(e,o,s),this.executeUpdate(e,o,s),this.executeAdd(e,o),this.updateSelection(s,"rowDataChanged"),t&&X(this.rootNode.allLeafChildren,t),o}isRowCountReady(){return this.rowCountReady}dispatchRowDataUpdateStartedEvent(e){this.eventService.dispatchEvent({type:"rowDataUpdateStarted",firstRowData:e?.length?e[0]:null})}updateSelection(e,t){const o=e.length>0;o&&this.selectionService.setNodesSelected({newValue:!1,nodes:e,suppressFinishActions:!0,source:t}),this.selectionService.updateGroupsFromChildrenSelections(t),o&&this.eventService.dispatchEvent({type:"selectionChanged",source:t})}executeAdd(e,t){const{add:o,addIndex:s}=e;if(y(o))return;const r=o.map(n=>this.createNode(n,this.rootNode,G)),i=this.rootNode.allLeafChildren;if(typeof s=="number"&&s>=0){const n=i.length;let a=s;if(this.gos.get("treeData")&&s>0&&n>0){for(let d=0;d<n;d++)if(i[d]?.rowIndex==s-1){a=d+1;break}}const u=i.slice(0,a),g=i.slice(a,i.length);this.rootNode.allLeafChildren=[...u,...r,...g]}else this.rootNode.allLeafChildren=[...i,...r];this.rootNode.sibling&&(this.rootNode.sibling.allLeafChildren=i),t.add=r}executeRemove(e,t,o){const{remove:s}=e;if(y(s))return;const r={};s.forEach(i=>{const n=this.lookupRowNode(i);n&&(n.isSelected()&&o.push(n),n.clearRowTopAndRowIndex(),r[n.id]=!0,delete this.allNodesMap[n.id],t.remove.push(n))}),this.rootNode.allLeafChildren=this.rootNode.allLeafChildren?.filter(i=>!r[i.id])??null,this.rootNode.sibling&&(this.rootNode.sibling.allLeafChildren=this.rootNode.allLeafChildren)}executeUpdate(e,t,o){const{update:s}=e;y(s)||s.forEach(r=>{const i=this.lookupRowNode(r);i&&(i.updateData(r),!i.selectable&&i.isSelected()&&o.push(i),this.setMasterForRow(i,r,G,!1),t.update.push(i))})}lookupRowNode(e){const t=this.gos.getRowIdCallback();let o;if(t){const s=t({data:e,level:0});if(o=this.allNodesMap[s],!o)return D(`could not find row id=${s}, data item was not found for this id`),null}else if(o=this.rootNode.allLeafChildren?.find(s=>s.data===e),!o)return D("could not find data item as object was not found",e),D("Consider using getRowId to help the Grid find matching row data"),null;return o||null}createNode(e,t,o){const s=new Q(this.beans);return s.group=!1,this.setMasterForRow(s,e,o,!0),t&&(s.parent=t),s.level=o,s.setDataAndId(e,this.nextId.toString()),this.allNodesMap[s.id]&&b(`duplicate node id '${s.id}' detected from getRowId callback, this could cause issues in your grid.`),this.allNodesMap[s.id]=s,this.nextId++,s}setMasterForRow(e,t,o,s){if(this.gos.get("treeData"))e.setMaster(!1),s&&(e.expanded=!1);else{if(this.gos.get("masterDetail")){const n=this.gos.get("isRowMaster");n?e.setMaster(n(t)):e.setMaster(!0)}else e.setMaster(!1);if(s){const n=this.funcColsService.getRowGroupColumns(),a=n?n.length:0,l=o+a;e.expanded=e.master?this.isExpanded(l):!1}}}isExpanded(e){const t=this.gos.get("groupDefaultExpanded");return t===-1?!0:e<t}},Z=class extends B{constructor(){super(...arguments),this.beanName="rowModel",this.onRowHeightChanged_debounced=W(this.onRowHeightChanged.bind(this),100),this.rowsToDisplay=[],this.hasStarted=!1,this.shouldSkipSettingDataOnStart=!1,this.isRefreshingModel=!1,this.rowCountReady=!1}wireBeans(e){this.beans=e,this.columnModel=e.columnModel,this.funcColsService=e.funcColsService,this.selectionService=e.selectionService,this.valueCache=e.valueCache,this.environment=e.environment,this.filterStage=e.filterStage,this.sortStage=e.sortStage,this.flattenStage=e.flattenStage,this.groupStage=e.groupStage,this.aggregationStage=e.aggregationStage,this.pivotStage=e.pivotStage,this.filterAggregatesStage=e.filterAggregatesStage}postConstruct(){const e=this.refreshModel.bind(this,{step:h.EVERYTHING}),t=!this.gos.get("suppressAnimationFrame"),o=this.refreshModel.bind(this,{step:h.EVERYTHING,afterColumnsChanged:!0,keepRenderedRows:!0,animate:t});this.addManagedEventListeners({newColumnsLoaded:o,columnRowGroupChanged:e,columnValueChanged:this.onValueChanged.bind(this),columnPivotChanged:this.refreshModel.bind(this,{step:h.PIVOT}),filterChanged:this.onFilterChanged.bind(this),sortChanged:this.onSortChanged.bind(this),columnPivotModeChanged:e,gridStylesChanged:this.onGridStylesChanges.bind(this),gridReady:this.onGridReady.bind(this)}),this.addPropertyListeners(),this.rootNode=new F(this.beans),this.nodeManager=new J(this.rootNode,this.gos,this.eventService,this.funcColsService,this.selectionService,this.beans)}addPropertyListeners(){const e=new Set(["treeData","masterDetail"]),t=new Set(["groupDefaultExpanded","groupAllowUnbalanced","initialGroupOrderComparator","groupHideOpenParents","groupDisplayType"]),o=new Set(["excludeChildrenWhenTreeDataFiltering"]),s=new Set(["removePivotHeaderRowWhenSingleValueColumn","pivotRowTotals","pivotColumnGroupTotals","suppressExpandablePivotGroups"]),r=new Set(["getGroupRowAgg","alwaysAggregateAtRootLevel","groupIncludeTotalFooter","suppressAggFilteredOnly","grandTotalRow"]),i=new Set(["postSortRows","groupDisplayType","accentedSort"]),n=new Set([]),a=new Set(["groupRemoveSingleChildren","groupRemoveLowestSingleChildren","groupIncludeFooter","groupTotalRow"]),l=[...e,...t,...o,...s,...s,...r,...i,...n,...a];this.addManagedPropertyListeners(l,u=>{const g=u.changeSet?.properties;if(!g)return;const d=c=>g.some(R=>c.has(R));if(d(e)){this.setRowData(this.rootNode.allLeafChildren.map(c=>c.data));return}if(d(t)){this.refreshModel({step:h.EVERYTHING});return}if(d(o)){this.refreshModel({step:h.FILTER});return}if(d(s)){this.refreshModel({step:h.PIVOT});return}if(d(r)){this.refreshModel({step:h.AGGREGATE});return}if(d(i)){this.refreshModel({step:h.SORT});return}if(d(n)){this.refreshModel({step:h.FILTER_AGGREGATES});return}d(a)&&this.refreshModel({step:h.MAP})}),this.addManagedPropertyListener("rowHeight",()=>this.resetRowHeights())}start(){this.hasStarted=!0,this.shouldSkipSettingDataOnStart?this.dispatchUpdateEventsAndRefresh():this.setInitialData()}setInitialData(){const e=this.gos.get("rowData");e&&(this.shouldSkipSettingDataOnStart=!0,this.setRowData(e))}ensureRowHeightsValid(e,t,o,s){let r,i=!1;do{r=!1;const n=this.getRowIndexAtPixel(e),a=this.getRowIndexAtPixel(t),l=Math.max(n,o),u=Math.min(a,s);for(let g=l;g<=u;g++){const d=this.getRow(g);if(d.rowHeightEstimated){const c=this.gos.getRowHeightForNode(d);d.setRowHeight(c.height),r=!0,i=!0}}r&&this.setRowTopAndRowIndex()}while(r);return i}setRowTopAndRowIndex(){const e=this.environment.getDefaultRowHeight();let t=0;const o=new Set,s=this.gos.isDomLayout("normal");for(let r=0;r<this.rowsToDisplay.length;r++){const i=this.rowsToDisplay[r];if(i.id!=null&&o.add(i.id),i.rowHeight==null){const n=this.gos.getRowHeightForNode(i,s,e);i.setRowHeight(n.height,n.estimated)}i.setRowTop(t),i.setRowIndex(r),t+=i.rowHeight}return o}clearRowTopAndRowIndex(e,t){const o=e.isActive(),s=i=>{i&&i.id!=null&&!t.has(i.id)&&i.clearRowTopAndRowIndex()},r=i=>{if(s(i),s(i.detailNode),s(i.sibling),i.hasChildren()&&i.childrenAfterGroup){const n=i.level==-1;o&&!n&&!i.expanded||i.childrenAfterGroup.forEach(r)}};r(this.rootNode)}ensureRowsAtPixel(e,t,o=0){const s=this.getRowIndexAtPixel(t),r=this.getRow(s),i=!this.gos.get("suppressAnimationFrame");return r===e[0]?!1:(e.forEach(n=>{K(this.rootNode.allLeafChildren,n)}),e.forEach((n,a)=>{Y(this.rootNode.allLeafChildren,n,Math.max(s+o,0)+a)}),this.refreshModel({step:h.EVERYTHING,keepRenderedRows:!0,keepEditingRows:!0,animate:i}),!0)}highlightRowAtPixel(e,t){const o=t!=null?this.getRowIndexAtPixel(t):null,s=o!=null?this.getRow(o):null;if(!s||!e||s===e||t==null){this.lastHighlightedRow&&(this.lastHighlightedRow.setHighlighted(null),this.lastHighlightedRow=null);return}const r=this.getHighlightPosition(t,s);this.lastHighlightedRow&&this.lastHighlightedRow!==s&&(this.lastHighlightedRow.setHighlighted(null),this.lastHighlightedRow=null),s.setHighlighted(r),this.lastHighlightedRow=s}getHighlightPosition(e,t){if(!t){const r=this.getRowIndexAtPixel(e);if(t=this.getRow(r||0),!t)return M.Below}const{rowTop:o,rowHeight:s}=t;return e-o<s/2?M.Above:M.Below}getLastHighlightedRowNode(){return this.lastHighlightedRow}isLastRowIndexKnown(){return!0}getRowCount(){return this.rowsToDisplay?this.rowsToDisplay.length:0}getTopLevelRowCount(){if(this.rowsToDisplay&&this.rowsToDisplay[0]===this.rootNode)return 1;const t=this.rootNode.sibling?1:0,o=this.rootNode.childrenAfterAggFilter;return(o?o.length:0)+t}getTopLevelRowDisplayedIndex(e){if(this.rowsToDisplay&&this.rowsToDisplay[0]===this.rootNode)return e;let o=e;if(this.rowsToDisplay[0].footer){if(e===0)return 0;o-=1}const s=this.rowsToDisplay[this.rowsToDisplay.length-1],r=o>=this.rootNode.childrenAfterSort.length;if(s.footer&&r)return s.rowIndex;let i=this.rootNode.childrenAfterSort[o];if(this.gos.get("groupHideOpenParents"))for(;i.expanded&&i.childrenAfterSort&&i.childrenAfterSort.length>0;)i=i.childrenAfterSort[0];return i.rowIndex}getRowBounds(e){if(S(this.rowsToDisplay))return null;const t=this.rowsToDisplay[e];return t?{rowTop:t.rowTop,rowHeight:t.rowHeight}:null}onRowGroupOpened(){const e=this.gos.isAnimateRows();this.refreshModel({step:h.MAP,keepRenderedRows:!0,animate:e})}onFilterChanged(e){if(e.afterDataChange)return;const t=this.gos.isAnimateRows(),s=e.columns.length===0||e.columns.some(r=>r.isPrimary())?h.FILTER:h.FILTER_AGGREGATES;this.refreshModel({step:s,keepRenderedRows:!0,animate:t})}onSortChanged(){const e=this.gos.isAnimateRows();this.refreshModel({step:h.SORT,keepRenderedRows:!0,animate:e,keepEditingRows:!0})}getType(){return"clientSide"}onValueChanged(){this.columnModel.isPivotActive()?this.refreshModel({step:h.PIVOT}):this.refreshModel({step:h.AGGREGATE})}createChangePath(e){const t=$(e),o=new V(!1,this.rootNode);return(t||this.gos.get("treeData"))&&o.setInactive(),o}isSuppressModelUpdateAfterUpdateTransaction(e){if(!this.gos.get("suppressModelUpdateAfterUpdateTransaction")||e.rowNodeTransactions==null)return!1;const t=e.rowNodeTransactions.filter(s=>s.add!=null&&s.add.length>0||s.remove!=null&&s.remove.length>0);return t==null||t.length==0}buildRefreshModelParams(e){let t=h.EVERYTHING;const o={everything:h.EVERYTHING,group:h.EVERYTHING,filter:h.FILTER,map:h.MAP,aggregate:h.AGGREGATE,sort:h.SORT,pivot:h.PIVOT};if(N(e)&&(t=o[e]),S(t)){P(`invalid step ${e}, available steps are ${Object.keys(o).join(", ")}`);return}const s=!this.gos.get("suppressAnimationFrame");return{step:t,keepRenderedRows:!0,keepEditingRows:!0,animate:s}}refreshModel(e){if(!this.hasStarted||this.isRefreshingModel||this.columnModel.isChangeEventsDispatching())return;const t=typeof e=="object"&&"step"in e?e:this.buildRefreshModelParams(e);if(!t||this.isSuppressModelUpdateAfterUpdateTransaction(t))return;const o=this.createChangePath(t.rowNodeTransactions);switch(this.isRefreshingModel=!0,t.step){case h.EVERYTHING:this.doRowGrouping(t.rowNodeTransactions,t.rowNodeOrder,o,!!t.afterColumnsChanged);case h.FILTER:this.doFilter(o);case h.PIVOT:this.doPivot(o);case h.AGGREGATE:this.doAggregate(o);case h.FILTER_AGGREGATES:this.doFilterAggregates(o);case h.SORT:this.doSort(t.rowNodeTransactions,o);case h.MAP:this.doRowsToDisplay()}const s=this.setRowTopAndRowIndex();this.clearRowTopAndRowIndex(o,s),this.isRefreshingModel=!1,this.eventService.dispatchEvent({type:"modelUpdated",animate:t.animate,keepRenderedRows:t.keepRenderedRows,newData:t.newData,newPage:!1,keepUndoRedoStack:t.keepUndoRedoStack})}isEmpty(){const e=S(this.rootNode.allLeafChildren)||this.rootNode.allLeafChildren.length===0;return S(this.rootNode)||e||!this.columnModel.isReady()}isRowsToRender(){return N(this.rowsToDisplay)&&this.rowsToDisplay.length>0}getNodesInRangeForSelection(e,t){let o=!1,s=!1;const r=[],i=this.gos.get("groupSelectsChildren");return this.forEachNodeAfterFilterAndSort(n=>{if(s)return;if(o&&(n===t||n===e)&&(s=!0,n.group&&i)){r.push(...n.allLeafChildren);return}if(!o){if(n!==t&&n!==e)return;o=!0}if(!n.group||!i){r.push(n);return}}),r}setDatasource(e){P("should never call setDatasource on clientSideRowController")}getTopLevelNodes(){return this.rootNode?this.rootNode.childrenAfterGroup:null}getRootNode(){return this.rootNode}getRow(e){return this.rowsToDisplay[e]}isRowPresent(e){return this.rowsToDisplay.indexOf(e)>=0}getRowIndexAtPixel(e){if(this.isEmpty()||this.rowsToDisplay.length===0)return-1;let t=0,o=this.rowsToDisplay.length-1;if(e<=0)return 0;if(j(this.rowsToDisplay).rowTop<=e)return this.rowsToDisplay.length-1;let r=-1,i=-1;for(;;){const n=Math.floor((t+o)/2),a=this.rowsToDisplay[n];if(this.isRowInPixel(a,e)||(a.rowTop<e?t=n+1:a.rowTop>e&&(o=n-1),r===t&&i===o))return n;r=t,i=o}}isRowInPixel(e,t){const o=e.rowTop,s=e.rowTop+e.rowHeight;return o<=t&&s>t}forEachLeafNode(e){this.rootNode.allLeafChildren&&this.rootNode.allLeafChildren.forEach((t,o)=>e(t,o))}forEachNode(e,t=!1){this.recursivelyWalkNodesAndCallback({nodes:[...this.rootNode.childrenAfterGroup||[]],callback:e,recursionType:0,index:0,includeFooterNodes:t})}forEachNodeAfterFilter(e,t=!1){this.recursivelyWalkNodesAndCallback({nodes:[...this.rootNode.childrenAfterAggFilter||[]],callback:e,recursionType:1,index:0,includeFooterNodes:t})}forEachNodeAfterFilterAndSort(e,t=!1){this.recursivelyWalkNodesAndCallback({nodes:[...this.rootNode.childrenAfterSort||[]],callback:e,recursionType:2,index:0,includeFooterNodes:t})}forEachPivotNode(e,t=!1){this.recursivelyWalkNodesAndCallback({nodes:[this.rootNode],callback:e,recursionType:3,index:0,includeFooterNodes:t})}recursivelyWalkNodesAndCallback(e){const{nodes:t,callback:o,recursionType:s,includeFooterNodes:r}=e;let{index:i}=e;const n=a=>{const l=t[0]?.parent;if(!l)return;const u=r&&this.gos.getGrandTotalRow(),g=this.gos.getGroupTotalRowCallback(),d=r&&g({node:l});if(l===this.rootNode){u===a&&(l.createFooter(),o(l.sibling,i++));return}d===a&&(l.createFooter(),o(l.sibling,i++))};n("top");for(let a=0;a<t.length;a++){const l=t[a];if(o(l,i++),l.hasChildren()&&!l.footer){let u=null;switch(s){case 0:u=l.childrenAfterGroup;break;case 1:u=l.childrenAfterAggFilter;break;case 2:u=l.childrenAfterSort;break;case 3:u=l.leafGroup?null:l.childrenAfterSort;break}u&&(i=this.recursivelyWalkNodesAndCallback({nodes:[...u],callback:o,recursionType:s,index:i,includeFooterNodes:r}))}}return n("bottom"),i}doAggregate(e){this.aggregationStage?.execute({rowNode:this.rootNode,changedPath:e})}doFilterAggregates(e){this.filterAggregatesStage?this.filterAggregatesStage.execute({rowNode:this.rootNode,changedPath:e}):this.rootNode.childrenAfterAggFilter=this.rootNode.childrenAfterFilter}expandOrCollapseAll(e){const t=this.gos.get("treeData"),o=this.columnModel.isPivotActive(),s=r=>{r&&r.forEach(i=>{const n=()=>{i.expanded=e,s(i.childrenAfterGroup)};if(t){N(i.childrenAfterGroup)&&n();return}if(o){!i.leafGroup&&n();return}i.group&&n()})};this.rootNode&&s(this.rootNode.childrenAfterGroup),this.refreshModel({step:h.MAP}),this.eventService.dispatchEvent({type:"expandOrCollapseAll",source:e?"expandAll":"collapseAll"})}doSort(e,t){this.sortStage.execute({rowNode:this.rootNode,rowNodeTransactions:e,changedPath:t})}doRowGrouping(e,t,o,s){this.groupStage?(e?this.groupStage.execute({rowNode:this.rootNode,rowNodeTransactions:e,rowNodeOrder:t,changedPath:o}):this.groupStage.execute({rowNode:this.rootNode,changedPath:o,afterColumnsChanged:s}),this.gos.get("groupSelectsChildren")&&this.selectionService.updateGroupsFromChildrenSelections("rowGroupChanged",o)&&this.eventService.dispatchEvent({type:"selectionChanged",source:"rowGroupChanged"})):(this.rootNode.childrenAfterGroup=this.rootNode.allLeafChildren,this.rootNode.sibling&&(this.rootNode.sibling.childrenAfterGroup=this.rootNode.childrenAfterGroup),this.rootNode.updateHasChildren()),this.nodeManager.isRowCountReady()&&(this.rowCountReady=!0,this.eventService.dispatchEventOnce({type:"rowCountReady"}))}doFilter(e){this.filterStage.execute({rowNode:this.rootNode,changedPath:e})}doPivot(e){this.pivotStage?.execute({rowNode:this.rootNode,changedPath:e})}getCopyOfNodesMap(){return this.nodeManager.getCopyOfNodesMap()}getRowNode(e){if(typeof e=="string"&&e.indexOf(F.ID_PREFIX_ROW_GROUP)==0){let o;return this.forEachNode(s=>{s.id===e&&(o=s)}),o}return this.nodeManager.getRowNode(e)}setRowData(e){this.selectionService.reset("rowDataChanged"),this.nodeManager.setRowData(e),this.hasStarted&&this.dispatchUpdateEventsAndRefresh()}dispatchUpdateEventsAndRefresh(){this.eventService.dispatchEvent({type:"rowDataUpdated"}),this.refreshModel({step:h.EVERYTHING,newData:!0})}batchUpdateRowData(e,t){if(this.applyAsyncTransactionsTimeout==null){this.rowDataTransactionBatch=[];const o=this.gos.getAsyncTransactionWaitMillis();this.applyAsyncTransactionsTimeout=window.setTimeout(()=>{this.executeBatchUpdateRowData()},o)}this.rowDataTransactionBatch.push({rowDataTransaction:e,callback:t})}flushAsyncTransactions(){this.applyAsyncTransactionsTimeout!=null&&(clearTimeout(this.applyAsyncTransactionsTimeout),this.executeBatchUpdateRowData())}executeBatchUpdateRowData(){this.valueCache.onDataChanged();const e=[],t=[];let o=!1;this.rowDataTransactionBatch&&this.rowDataTransactionBatch.forEach(s=>{const r=this.nodeManager.updateRowData(s.rowDataTransaction,void 0);t.push(r),s.callback&&e.push(s.callback.bind(null,r)),typeof s.rowDataTransaction.addIndex=="number"&&(o=!0)}),this.commonUpdateRowData(t,void 0,o),e.length>0&&window.setTimeout(()=>{e.forEach(s=>s())},0),t.length>0&&this.eventService.dispatchEvent({type:"asyncTransactionsFlushed",results:t}),this.rowDataTransactionBatch=null,this.applyAsyncTransactionsTimeout=void 0}updateRowData(e,t){this.valueCache.onDataChanged();const o=this.nodeManager.updateRowData(e,t),s=typeof e.addIndex=="number";return this.commonUpdateRowData([o],t,s),o}createRowNodeOrder(){if(this.gos.get("suppressMaintainUnsortedOrder"))return;const t={};if(this.rootNode&&this.rootNode.allLeafChildren)for(let o=0;o<this.rootNode.allLeafChildren.length;o++){const s=this.rootNode.allLeafChildren[o];t[s.id]=o}return t}commonUpdateRowData(e,t,o){if(!this.hasStarted)return;const s=!this.gos.get("suppressAnimationFrame");o&&(t=this.createRowNodeOrder()),this.eventService.dispatchEvent({type:"rowDataUpdated"}),this.refreshModel({step:h.EVERYTHING,rowNodeTransactions:e,rowNodeOrder:t,keepRenderedRows:!0,keepEditingRows:!0,animate:s})}doRowsToDisplay(){this.rowsToDisplay=this.flattenStage.execute({rowNode:this.rootNode})}onRowHeightChanged(){this.refreshModel({step:h.MAP,keepRenderedRows:!0,keepEditingRows:!0,keepUndoRedoStack:!0})}onRowHeightChangedDebounced(){this.onRowHeightChanged_debounced()}resetRowHeights(){const e=this.resetRowHeightsForAllRowNodes();this.rootNode.setRowHeight(this.rootNode.rowHeight,!0),this.rootNode.sibling&&this.rootNode.sibling.setRowHeight(this.rootNode.sibling.rowHeight,!0),e&&this.onRowHeightChanged()}resetRowHeightsForAllRowNodes(){let e=!1;return this.forEachNode(t=>{t.setRowHeight(t.rowHeight,!0);const o=t.detailNode;o&&o.setRowHeight(o.rowHeight,!0),t.sibling&&t.sibling.setRowHeight(t.sibling.rowHeight,!0),e=!0}),e}onGridStylesChanges(e){if(e.rowHeightChanged){if(this.columnModel.isAutoRowHeightActive())return;this.resetRowHeights()}}onGridReady(){this.hasStarted||this.setInitialData()}isRowDataLoaded(){return this.rowCountReady}};import{_warnOnce as ee}from"@ag-grid-community/core";function te(e){e.expansionService.onGroupExpandedOrCollapsed()}function oe(e,t){e.rowModelHelperService?.getClientSideRowModel()?.refreshModel(t)}function se(e,t){e.rowModelHelperService?.getClientSideRowModel()?.forEachLeafNode(t)}function ie(e,t){e.rowModelHelperService?.getClientSideRowModel()?.forEachNodeAfterFilter(t)}function re(e,t){e.rowModelHelperService?.getClientSideRowModel()?.forEachNodeAfterFilterAndSort(t)}function ne(e){if(e.columnModel.isAutoRowHeightActive()){ee("calling gridApi.resetRowHeights() makes no sense when using Auto Row Height.");return}e.rowModelHelperService?.getClientSideRowModel()?.resetRowHeights()}function ae(e,t){return e.frameworkOverrides.wrapIncoming(()=>e.rowModelHelperService?.getClientSideRowModel()?.updateRowData(t))}function le(e,t,o){e.frameworkOverrides.wrapIncoming(()=>e.rowModelHelperService?.getClientSideRowModel()?.batchUpdateRowData(t,o))}function de(e){e.frameworkOverrides.wrapIncoming(()=>e.rowModelHelperService?.getClientSideRowModel()?.flushAsyncTransactions())}function he(e){return e.selectionService.getBestCostNodeSelection()}import{BeanStub as ce}from"@ag-grid-community/core";var ue=class extends ce{constructor(){super(...arguments),this.beanName="filterStage"}wireBeans(e){this.filterManager=e.filterManager}execute(e){const{changedPath:t}=e;this.filter(t)}filter(e){const t=!!this.filterManager?.isChildFilterPresent();this.filterNodes(t,e)}filterNodes(e,t){const o=(s,r)=>{s.hasChildren()&&e&&!r?s.childrenAfterFilter=s.childrenAfterGroup.filter(i=>{const n=i.childrenAfterFilter&&i.childrenAfterFilter.length>0,a=i.data&&this.filterManager.doesRowPassFilter({rowNode:i});return n||a}):s.childrenAfterFilter=s.childrenAfterGroup,s.sibling&&(s.sibling.childrenAfterFilter=s.childrenAfterFilter)};if(this.doingTreeDataFiltering()){const s=(i,n)=>{if(i.childrenAfterGroup)for(let a=0;a<i.childrenAfterGroup.length;a++){const l=i.childrenAfterGroup[a],u=n||this.filterManager.doesRowPassFilter({rowNode:l});l.childrenAfterGroup?s(i.childrenAfterGroup[a],u):o(l,u)}o(i,n)},r=i=>s(i,!1);t.executeFromRootNode(r)}else{const s=r=>o(r,!1);t.forEachChangedNodeDepthFirst(s,!0)}}doingTreeDataFiltering(){return this.gos.get("treeData")&&!this.gos.get("excludeChildrenWhenTreeDataFiltering")}};import{BeanStub as ge,RowNode as pe,_exists as H,_missingOrEmpty as fe}from"@ag-grid-community/core";var we=class extends ge{constructor(){super(...arguments),this.beanName="flattenStage"}wireBeans(e){this.beans=e,this.columnModel=e.columnModel}execute(e){const t=e.rowNode,o=[],s=this.columnModel.isPivotMode(),r=s&&t.leafGroup,i=r?[t]:t.childrenAfterSort,n=this.getFlattenDetails();this.recursivelyAddToRowsToDisplay(n,i,o,s,0);const a=o.length>0;if(!r&&a&&n.grandTotalRow){t.createFooter();const u=n.grandTotalRow==="top";this.addRowNodeToRowsToDisplay(n,t.sibling,o,0,u)}return o}getFlattenDetails(){const e=this.gos.get("groupRemoveSingleChildren");return{groupRemoveLowestSingleChildren:!e&&this.gos.get("groupRemoveLowestSingleChildren"),groupRemoveSingleChildren:e,isGroupMultiAutoColumn:this.gos.isGroupMultiAutoColumn(),hideOpenParents:this.gos.get("groupHideOpenParents"),grandTotalRow:this.gos.getGrandTotalRow(),groupTotalRow:this.gos.getGroupTotalRowCallback()}}recursivelyAddToRowsToDisplay(e,t,o,s,r){if(!fe(t))for(let i=0;i<t.length;i++){const n=t[i],a=n.hasChildren(),l=s&&!a,u=e.groupRemoveSingleChildren&&a&&n.childrenAfterGroup.length===1,g=e.groupRemoveLowestSingleChildren&&a&&n.leafGroup&&n.childrenAfterGroup.length===1,d=s&&n.leafGroup,c=e.hideOpenParents&&n.expanded&&!n.master&&!d;if(!l&&!c&&!u&&!g&&this.addRowNodeToRowsToDisplay(e,n,o,r),!(s&&n.leafGroup)){if(a){const f=u||g;if(n.expanded||f){const p=e.groupTotalRow({node:n});p||n.destroyFooter();const w=f?r:r+1;p==="top"&&(n.createFooter(),this.addRowNodeToRowsToDisplay(e,n.sibling,o,w)),this.recursivelyAddToRowsToDisplay(e,n.childrenAfterSort,o,s,w),p==="bottom"&&(n.createFooter(),this.addRowNodeToRowsToDisplay(e,n.sibling,o,w))}}else if(n.master&&n.expanded){const f=this.createDetailNode(n);this.addRowNodeToRowsToDisplay(e,f,o,r)}}}}addRowNodeToRowsToDisplay(e,t,o,s,r){r?o.unshift(t):o.push(t),t.setUiLevel(e.isGroupMultiAutoColumn?0:s)}createDetailNode(e){if(H(e.detailNode))return e.detailNode;const t=new pe(this.beans);return t.detail=!0,t.selectable=!1,t.parent=e,H(e.id)&&(t.id="detail_"+e.id),t.data=e.data,t.level=e.level+1,e.detailNode=t,t}};import{BeanStub as Re,_errorOnce as O,_exists as Se,_iterateObject as me,_missing as Ae}from"@ag-grid-community/core";var Ce=class extends Re{constructor(){super(...arguments),this.beanName="immutableService"}wireBeans(e){this.rowModel=e.rowModel,this.selectionService=e.selectionService}postConstruct(){this.rowModel.getType()==="clientSide"&&(this.clientSideRowModel=this.rowModel,this.addManagedPropertyListener("rowData",()=>this.onRowDataUpdated()))}isActive(){const e=this.gos.exists("getRowId");return this.gos.get("resetRowDataOnUpdate")?!1:e}setRowData(e){const t=this.createTransactionForRowData(e);if(!t)return;const[o,s]=t;this.clientSideRowModel.updateRowData(o,s)}createTransactionForRowData(e){if(Ae(this.clientSideRowModel)){O("ImmutableService only works with ClientSideRowModel");return}const t=this.gos.getRowIdCallback();if(t==null){O("ImmutableService requires getRowId() callback to be implemented, your row data needs IDs!");return}const o={remove:[],update:[],add:[]},s=this.clientSideRowModel.getCopyOfNodesMap(),i=this.gos.get("suppressMaintainUnsortedOrder")?void 0:{};return Se(e)&&e.forEach((n,a)=>{const l=t({data:n,level:0}),u=s[l];i&&(i[l]=a),u?(u.data!==n&&o.update.push(n),s[l]=void 0):o.add.push(n)}),me(s,(n,a)=>{a&&o.remove.push(a.data)}),[o,i]}onRowDataUpdated(){const e=this.gos.get("rowData");e&&(this.isActive()?this.setRowData(e):(this.selectionService.reset("rowDataChanged"),this.clientSideRowModel.setRowData(e)))}};import{BeanStub as ve,_errorOnce as Te,_missing as I,_warnOnce as Me}from"@ag-grid-community/core";var Ne=class extends ve{constructor(){super(...arguments),this.beanName="sortService"}wireBeans(e){this.columnModel=e.columnModel,this.funcColsService=e.funcColsService,this.rowNodeSorter=e.rowNodeSorter,this.showRowGroupColsService=e.showRowGroupColsService}sort(e,t,o,s,r,i){const n=this.gos.get("groupMaintainOrder"),a=this.columnModel.getCols().some(c=>c.isRowGroupActive());let l={};o&&s&&(l=this.calculateDirtyNodes(s));const u=this.columnModel.isPivotMode(),g=this.gos.getCallback("postSortRows"),d=c=>{this.pullDownGroupDataForHideOpenParents(c.childrenAfterAggFilter,!0);const R=u&&c.leafGroup;if(n&&a&&!c.leafGroup&&!i){const w=this.funcColsService.getRowGroupColumns()?.[c.level+1]?.getSort()===null,x=c.childrenAfterAggFilter.slice(0);if(c.childrenAfterSort&&!w){const m={};c.childrenAfterSort.forEach((A,C)=>{m[A.id]=C}),x.sort((A,C)=>(m[A.id]??0)-(m[C.id]??0))}c.childrenAfterSort=x}else!t||R?c.childrenAfterSort=c.childrenAfterAggFilter.slice(0):o?c.childrenAfterSort=this.doDeltaSort(c,l,r,e):c.childrenAfterSort=this.rowNodeSorter.doFullSort(c.childrenAfterAggFilter,e);if(c.sibling&&(c.sibling.childrenAfterSort=c.childrenAfterSort),this.updateChildIndexes(c),g){const p={nodes:c.childrenAfterSort};g(p)}};r&&r.forEachChangedNodeDepthFirst(d),this.updateGroupDataForHideOpenParents(r)}calculateDirtyNodes(e){const t={},o=s=>{s&&s.forEach(r=>t[r.id]=!0)};return e&&e.forEach(s=>{o(s.add),o(s.update),o(s.remove)}),t}doDeltaSort(e,t,o,s){const r=e.childrenAfterAggFilter,i=e.childrenAfterSort;if(!i)return this.rowNodeSorter.doFullSort(r,s);const n={},a=[];r.forEach(d=>{t[d.id]||!o.canSkip(d)?a.push(d):n[d.id]=!0});const l=i.filter(d=>n[d.id]),u=(d,c)=>({currentPos:c,rowNode:d}),g=a.map(u).sort((d,c)=>this.rowNodeSorter.compareRowNodes(s,d,c));return this.mergeSortedArrays(s,g,l.map(u)).map(({rowNode:d})=>d)}mergeSortedArrays(e,t,o){const s=[];let r=0,i=0;for(;r<t.length&&i<o.length;)this.rowNodeSorter.compareRowNodes(e,t[r],o[i])<0?s.push(t[r++]):s.push(o[i++]);for(;r<t.length;)s.push(t[r++]);for(;i<o.length;)s.push(o[i++]);return s}updateChildIndexes(e){if(I(e.childrenAfterSort))return;const t=e.childrenAfterSort;for(let o=0;o<t.length;o++){const s=t[o],r=o===0,i=o===e.childrenAfterSort.length-1;s.setFirstChild(r),s.setLastChild(i),s.setChildIndex(o)}}updateGroupDataForHideOpenParents(e){if(!this.gos.get("groupHideOpenParents"))return;if(this.gos.get("treeData"))return Me("The property hideOpenParents dose not work with Tree Data. This is because Tree Data has values at the group level, it doesn't make sense to hide them."),!1;const t=o=>{this.pullDownGroupDataForHideOpenParents(o.childrenAfterSort,!1),o.childrenAfterSort.forEach(s=>{s.hasChildren()&&t(s)})};e&&e.executeFromRootNode(o=>t(o))}pullDownGroupDataForHideOpenParents(e,t){!this.gos.get("groupHideOpenParents")||I(e)||e.forEach(o=>{(this.showRowGroupColsService?.getShowRowGroupCols()??[]).forEach(r=>{const i=r.getColDef().showRowGroup;if(typeof i!="string"){Te("groupHideOpenParents only works when specifying specific columns for colDef.showRowGroup");return}const n=i,a=this.columnModel.getColDefCol(n);if(a!==o.rowGroupColumn)if(t)o.setGroupValue(r.getId(),void 0);else{const u=o.getFirstChildOfFirstChild(a);u&&o.setGroupValue(r.getId(),u.key)}})})}};import{BeanStub as De,_exists as k}from"@ag-grid-community/core";var ye=class extends De{constructor(){super(...arguments),this.beanName="sortStage"}wireBeans(e){this.sortService=e.sortService,this.sortController=e.sortController}execute(e){const t=this.sortController.getSortOptions(),o=k(t)&&t.length>0,s=o&&k(e.rowNodeTransactions)&&this.gos.get("deltaSort"),r=t.some(i=>this.gos.isColumnsSortingCoupledToGroup()?i.column.isPrimary()&&i.column.isRowGroupActive():!!i.column.getColDef().showRowGroup);this.sortService.sort(t,o,s,e.rowNodeTransactions,e.changedPath,r)}},E="32.1.0",L=v({version:E,moduleName:`${T.ClientSideRowModelModule}-core`,rowModel:"clientSide",beans:[Z,ue,ye,we,Ne,Ce]}),Ge=v({version:E,moduleName:`${T.ClientSideRowModelModule}-api`,beans:[_],apiFunctions:{onGroupExpandedOrCollapsed:te,refreshClientSideRowModel:oe,forEachLeafNode:se,forEachNodeAfterFilter:ie,forEachNodeAfterFilterAndSort:re,resetRowHeights:ne,applyTransaction:ae,applyTransactionAsync:le,flushAsyncTransactions:de,getBestCostNodeSelection:he},dependantModules:[L,U]}),Ee=v({version:E,moduleName:T.ClientSideRowModelModule,dependantModules:[L,Ge]});export{Ee as ClientSideRowModelModule};
